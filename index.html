<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Merchant Portal</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial;
  background:#f5f7fb;
  padding:40px;
}

.card {
  max-width:500px;
  margin:auto;
  background:white;
  padding:25px;
  border-radius:14px;
}

input {
  width:100%;
  padding:12px;
  margin-top:8px;
}

button {
  width:100%;
  padding:14px;
  margin-top:16px;
  background:black;
  color:white;
  border:none;
}

</style>

</head>
<body>

<div class="card">

<h2>Merchant Redemption</h2>

<button onclick="logout()">Logout</button>

<br><br>

<label>Member Number</label>
<input id="memberNumber">

<label>Original Bill</label>
<input id="original" type="number">

<label>Discount Value</label>
<input id="discountValue" type="number">

<label>Final Bill</label>
<input id="final" type="number">

<button onclick="submitRedemption()">Submit Redemption</button>

<br><br>

<div id="result"></div>

</div>

<script>

const supabase = window.supabase.createClient(
  "https://wyzwjfaiggymxfjkrfuq.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5endqZmFpZ2d5bXhmamtyZnVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMDc2MTIsImV4cCI6MjA4NTc4MzYxMn0.oPzAaijIIKls2fUYqPk3cvkegSPN8Iu9h8xnnZkg1JE"
);

let MERCHANT_ID = null;

/* ================= LOAD SESSION ================= */

async function loadSession() {

  const { data } = await supabase.auth.getSession();

  if (!data.session) {
    window.location.href = "./login.html";
    return;
  }

  const userId = data.session.user.id;

  const { data: merchant } = await supabase
    .from("merchants")
    .select("id")
    .eq("auth_user_id", userId)
    .single();

  if (!merchant) {
    alert("Merchant not linked");
    return;
  }

  MERCHANT_ID = merchant.id;
}

loadSession();

/* ================= LOGOUT ================= */

async function logout() {
  await supabase.auth.signOut();
  window.location.href = "./login.html";
}

/* ================= SUBMIT ================= */

async function submitRedemption() {

  const resultBox = document.getElementById("result");

  resultBox.innerText = "Processing...";

  const memberNumber = document.getElementById("memberNumber").value;
  const original = Number(document.getElementById("original").value);
  const discount = Number(document.getElementById("discountValue").value);
  const finalBill = Number(document.getElementById("final").value);

  const { data: member } = await supabase
    .from("members")
    .select("id")
    .eq("member_number", memberNumber)
    .single();

  if (!member) {
    resultBox.innerText = "Member not found";
    return;
  }

  const { data, error } = await supabase.rpc("create_redemption", {
    p_member_id: member.id,
    p_merchant_id: MERCHANT_ID,
    p_original_bill: original,
    p_discount: discount,
    p_final_bill: finalBill
  });

  if (error) {
    resultBox.innerText = error.message;
    return;
  }

  resultBox.innerText =
    "Points Added: " + data.points_added +
    " | New Balance: " + data.new_balance;

}

</script>

</body>
</html>
