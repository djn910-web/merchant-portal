<script>

const SUPABASE_URL = "https://wyzwjfaiggymxfjkrfuq.supabase.co";

const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5endqZmFpZ2d5bXhmamtyZnVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMDc2MTIsImV4cCI6MjA4NTc4MzYxMn0.oPzAaijIIKls2fUYqPk3cvkegSPN8Iu9h8xnnZkg1JE";

const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ================= SESSION SAFE LOAD ================= */

let MERCHANT_ID = null;
let sessionReady = false;

async function initSession() {

  try {

    // Wait for Supabase to restore session from storage
    await new Promise(r => setTimeout(r, 250));

    const { data } = await supabaseClient.auth.getSession();

    if (!data.session) {
      window.location.href = "./login.html";
      return;
    }

    const userId = data.session.user.id;

    const { data: merchant } = await supabaseClient
      .from("merchants")
      .select("id")
      .eq("auth_user_id", userId)
      .maybeSingle();

    if (!merchant) {
      alert("Merchant not linked to this login");
      await supabaseClient.auth.signOut();
      window.location.href = "./login.html";
      return;
    }

    MERCHANT_ID = merchant.id;
    sessionReady = true;

  } catch (err) {
    console.error(err);
    alert("Session load failed. Reload page.");
  }

}

initSession();

/* ================= IDLE AUTO LOGOUT ================= */

let idleTimer;

function resetIdleTimer() {
  clearTimeout(idleTimer);
  idleTimer = setTimeout(async () => {
    alert("Session expired (5 min idle)");
    await supabaseClient.auth.signOut();
    window.location.href = "./login.html";
  }, 5 * 60 * 1000);
}

["click","mousemove","keypress","touchstart"].forEach(event => {
  document.addEventListener(event, resetIdleTimer);
});

resetIdleTimer();

/* ================= LOGOUT BUTTON ================= */

document.getElementById("logoutBtn").addEventListener("click", async () => {
  await supabaseClient.auth.signOut();
  window.location.href = "./login.html";
});

/* ================= BILL CALC ================= */

function calculateFinal() {

const original = Number(document.getElementById("original").value);
const discountValue = Number(document.getElementById("discountValue").value);
const type = document.getElementById("discountType").value;

if (!original || !discountValue) return;

let final;

if (type === "percent") {
  final = original - (original * discountValue / 100);
} else {
  final = original - discountValue;
}

if (final < 0) final = 0;

document.getElementById("final").value = final.toFixed(2);
}

document.getElementById("original").addEventListener("input", calculateFinal);
document.getElementById("discountValue").addEventListener("input", calculateFinal);
document.getElementById("discountType").addEventListener("change", calculateFinal);

/* ================= SUBMIT LOCK ================= */

let submitting = false;

document.getElementById("submitBtn").addEventListener("click", async () => {

if (submitting) return;
if (!sessionReady) return alert("Session still loading...");

submitting = true;

const resultBox = document.getElementById("result");

try {

resultBox.style.display="block";
resultBox.className="result";
resultBox.innerText="Processing...";

const memberNumber = document.getElementById("memberNumber").value.trim();
const original = Number(document.getElementById("original").value);
const finalBill = Number(document.getElementById("final").value);

if (!memberNumber) throw new Error("Enter member number");
if (original <= 0) throw new Error("Invalid bill");

const discount = original - finalBill;

const { data: member } = await supabaseClient
.from("members")
.select("id")
.eq("member_number", memberNumber)
.maybeSingle();

if (!member) throw new Error("Member not found");

const { data, error } = await supabaseClient.rpc("create_redemption", {
 p_member_id: member.id,
 p_merchant_id: MERCHANT_ID,
 p_original_bill: original,
 p_discount: discount,
 p_final_bill: finalBill
});

if (error) throw error;

resultBox.className="result success";
resultBox.innerText =
"Points Added: " + data.points_added +
" | Balance: " + data.new_balance;

}
catch(e){
 resultBox.className="result error";
 resultBox.innerText=e.message;
}

submitting = false;

});

</script>
