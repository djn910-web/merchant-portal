<script>

const SUPABASE_URL = "https://wyzwjfaiggymxfjkrfuq.supabase.co";
const SUPABASE_ANON_KEY = "PASTE_YOUR_KEY_HERE";

const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ================= SESSION + MERCHANT CHECK ================= */

let MERCHANT_ID = null;
let sessionReady = false;

async function requireMerchantSession() {

  console.log("Checking session...");

  // Wait for Supabase to restore session from storage
  await new Promise(resolve => setTimeout(resolve, 300));

  const { data: { session } } = await supabaseClient.auth.getSession();

  console.log("Session:", session);

  if (!session) {
    window.location.href = "./login.html";
    return;
  }

  const userId = session.user.id;

  console.log("Looking up merchant for user:", userId);

  const { data: merchant, error } = await supabaseClient
    .from("merchants")
    .select("id")
    .eq("auth_user_id", userId)
    .maybeSingle();   // SAFER than single()

  console.log("Merchant lookup result:", merchant, error);

  if (!merchant) {
    alert("Merchant not linked to this login");
    await supabaseClient.auth.signOut();
    window.location.href = "./login.html";
    return;
  }

  MERCHANT_ID = merchant.id;
  sessionReady = true;

  console.log("Merchant session ready:", MERCHANT_ID);
}

requireMerchantSession();

/* Listen for auth state changes (extra safety) */

supabaseClient.auth.onAuthStateChange((event, session) => {
  console.log("Auth state changed:", event);
});

/* ================= AUTO LOGOUT AFTER 5 MIN IDLE ================= */

let idleTimer;

function resetIdleTimer() {
  clearTimeout(idleTimer);
  idleTimer = setTimeout(async () => {
    alert("Session expired (5 min idle)");
    await supabaseClient.auth.signOut();
    window.location.href = "./login.html";
  }, 5 * 60 * 1000);
}

["click","mousemove","keypress","touchstart"].forEach(event => {
  document.addEventListener(event, resetIdleTimer);
});

resetIdleTimer();

/* ================= LOGOUT BUTTON ================= */

document.getElementById("logoutBtn").addEventListener("click", async () => {
  await supabaseClient.auth.signOut();
  window.location.href = "./login.html";
});

/* ================= BILL CALC ================= */

function calculateFinal() {

const original = Number(document.getElementById("original").value);
const discountValue = Number(document.getElementById("discountValue").value);
const type = document.getElementById("discountType").value;

if (!original || !discountValue) return;

let final;

if (type === "percent") {
  final = original - (original * discountValue / 100);
} else {
  final = original - discountValue;
}

if (final < 0) final = 0;

document.getElementById("final").value = final.toFixed(2);
}

document.getElementById("original").addEventListener("input", calculateFinal);
document.getElementById("discountValue").addEventListener("input", calculateFinal);
document.getElementById("discountType").addEventListener("change", calculateFinal);

/* ================= SUBMIT LOCK ================= */

let submitting = false;

document.getElementById("submitBtn").addEventListener("click", async () => {

if (submitting) return;
if (!sessionReady) return alert("Session still loading...");

submitting = true;

const resultBox = document.getElementById("result");

try {

resultBox.style.display="block";
resultBox.className="result";
resultBox.innerText="Processing...";

const memberNumber = document.getElementById("memberNumber").value.trim();
const original = Number(document.getElementById("original").value);
const finalBill = Number(document.getElementById("final").value);

if (!memberNumber) throw new Error("Enter member number");
if (original <= 0) throw new Error("Invalid bill");

const discount = original - finalBill;

const { data: member } = await supabaseClient
.from("members")
.select("id")
.eq("member_number", memberNumber)
.maybeSingle();

if (!member) throw new Error("Member not found");

const { data, error } = await supabaseClient.rpc("create_redemption", {
 p_member_id: member.id,
 p_merchant_id: MERCHANT_ID,
 p_original_bill: original,
 p_discount: discount,
 p_final_bill: finalBill
});

if (error) throw error;

resultBox.className="result success";
resultBox.innerText =
"Points Added: " + data.points_added +
" | Balance: " + data.new_balance;

}
catch(e){
 resultBox.className="result error";
 resultBox.innerText=e.message;
}

submitting = false;

});

</script>
