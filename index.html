<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Merchant Redemption</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { font-family: Arial; background:#f5f7fb; padding:40px; }

.card {
  max-width:500px;
  margin:auto;
  background:white;
  padding:25px;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
}

input, select {
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:8px;
  border:1px solid #ddd;
}

button {
  width:100%;
  padding:14px;
  margin-top:20px;
  border:none;
  border-radius:10px;
  background:black;
  color:white;
  font-weight:bold;
  cursor:pointer;
}

.result {
  margin-top:15px;
  padding:12px;
  border-radius:10px;
  display:none;
}

.success { background:#e8f8ee; color:#046b3a; }
.error { background:#ffe5e5; color:#a30000; }

.logout { background:#eee; color:#000; }

</style>
</head>

<body>

<div class="card">

<h2>Merchant Redemption</h2>

<button class="logout" id="logoutBtn">Logout</button>

<label>Member Number</label>
<input id="memberNumber">

<label>Original Bill (€)</label>
<input id="original" type="number">

<label>Discount Type</label>
<select id="discountType">
  <option value="eur">€ Amount</option>
  <option value="percent">% Percentage</option>
</select>

<label>Discount Value</label>
<input id="discountValue" type="number">

<label>Final Bill</label>
<input id="final" type="number" disabled>

<button id="submitBtn">Submit Redemption</button>

<div id="result" class="result"></div>

</div>

<script>

const SUPABASE_URL = "https://wyzwjfaiggymxfjkrfuq.supabase.co";
const SUPABASE_ANON_KEY = "PASTE_YOUR_KEY_HERE";

const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* SESSION + MERCHANT CHECK */

let MERCHANT_ID = null;
let sessionReady = false;

async function requireMerchantSession() {

  const { data: { session } } = await supabaseClient.auth.getSession();

  if (!session) {
    window.location.href = "./login.html";
    return;
  }

  const userId = session.user.id;

  const { data: merchant } = await supabaseClient
    .from("merchants")
    .select("id")
    .eq("auth_user_id", userId)
    .single();

  if (!merchant) {
    alert("Merchant not linked");
    await supabaseClient.auth.signOut();
    window.location.href = "./login.html";
    return;
  }

  MERCHANT_ID = merchant.id;
  sessionReady = true;
}

requireMerchantSession();

/* AUTO LOGOUT AFTER 5 MIN IDLE */

let idleTimer;

function resetIdleTimer() {
  clearTimeout(idleTimer);
  idleTimer = setTimeout(async () => {
    alert("Session expired (5 min idle)");
    await supabaseClient.auth.signOut();
    window.location.href = "./login.html";
  }, 5 * 60 * 1000);
}

["click","mousemove","keypress","touchstart"].forEach(event => {
  document.addEventListener(event, resetIdleTimer);
});

resetIdleTimer();

/* LOGOUT BUTTON */

document.getElementById("logoutBtn").addEventListener("click", async () => {
  await supabaseClient.auth.signOut();
  window.location.href = "./login.html";
});

/* BILL CALC */

function calculateFinal() {

const original = Number(document.getElementById("original").value);
const discountValue = Number(document.getElementById("discountValue").value);
const type = document.getElementById("discountType").value;

if (!original || !discountValue) return;

let final;

if (type === "percent") {
  final = original - (original * discountValue / 100);
} else {
  final = original - discountValue;
}

if (final < 0) final = 0;

document.getElementById("final").value = final.toFixed(2);
}

document.getElementById("original").addEventListener("input", calculateFinal);
document.getElementById("discountValue").addEventListener("input", calculateFinal);
document.getElementById("discountType").addEventListener("change", calculateFinal);

/* SUBMIT LOCK */

let submitting = false;

document.getElementById("submitBtn").addEventListener("click", async () => {

if (submitting) return;
if (!sessionReady) return alert("Session loading...");

submitting = true;

const resultBox = document.getElementById("result");

try {

resultBox.style.display="block";
resultBox.className="result";
resultBox.innerText="Processing...";

const memberNumber = document.getElementById("memberNumber").value.trim();
const original = Number(document.getElementById("original").value);
const finalBill = Number(document.getElementById("final").value);

if (!memberNumber) throw new Error("Enter member number");
if (original <= 0) throw new Error("Invalid bill");

const discount = original - finalBill;

const { data: member } = await supabaseClient
.from("members")
.select("id")
.eq("member_number", memberNumber)
.single();

if (!member) throw new Error("Member not found");

const { data, error } = await supabaseClient.rpc("create_redemption", {
 p_member_id: member.id,
 p_merchant_id: MERCHANT_ID,
 p_original_bill: original,
 p_discount: discount,
 p_final_bill: finalBill
});

if (error) throw error;

resultBox.className="result success";
resultBox.innerText =
"Points Added: " + data.points_added +
" | Balance: " + data.new_balance;

}
catch(e){
 resultBox.className="result error";
 resultBox.innerText=e.message;
}

submitting = false;

});

</script>

</body>
</html>
