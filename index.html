<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Merchant Redemption</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
font-family: Arial;
background:#f5f7fb;
padding:40px;
}

.card {
max-width:500px;
margin:auto;
background:white;
padding:25px;
border-radius:14px;
box-shadow:0 10px 30px rgba(0,0,0,0.08);
}

input, select {
width:100%;
padding:12px;
margin-top:8px;
border-radius:8px;
border:1px solid #ddd;
}

button {
width:100%;
padding:14px;
margin-top:20px;
border:none;
border-radius:10px;
background:black;
color:white;
font-weight:bold;
cursor:pointer;
}

.result {
margin-top:15px;
padding:12px;
border-radius:10px;
display:none;
}

.success { background:#e8f8ee; color:#046b3a; }
.error { background:#ffe5e5; color:#a30000; }

</style>
</head>

<body>

<div class="card">

<h2>Merchant Redemption</h2>

<button id="logoutBtn">Logout</button>

<label>Member Number</label>
<input id="memberNumber">

<label>Original Bill (€)</label>
<input id="original" type="number">

<label>Discount Type</label>
<select id="discountType">
<option value="eur">€ Amount</option>
<option value="percent">% Percentage</option>
</select>

<label>Discount Value</label>
<input id="discountValue" type="number">

<label>Final Bill (Auto Calculated)</label>
<input id="final" type="number" disabled>

<button id="submitBtn">Submit Redemption</button>

<div id="result" class="result"></div>

</div>

<script>

const SUPABASE_URL = "https://wyzwjfaiggymxfjkrfuq.supabase.co";

const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5endqZmFpZ2d5bXhmamtyZnVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMDc2MTIsImV4cCI6MjA4NTc4MzYxMn0.oPzAaijIIKls2fUYqPk3cvkegSPN8Iu9h8xnnZkg1JE";

const supabaseClient = window.supabase.createClient(
SUPABASE_URL,
SUPABASE_ANON_KEY
);

let MERCHANT_ID = null;

/* SESSION LOAD */

async function loadSession() {

const { data } = await supabaseClient.auth.getSession();

if (!data.session) {
window.location.href = "./login.html";
return;
}

const userId = data.session.user.id;

const { data: merchant } = await supabaseClient
.from("merchants")
.select("id")
.eq("auth_user_id", userId)
.single();

if (!merchant) {
alert("Merchant not linked");
return;
}

MERCHANT_ID = merchant.id;

}

loadSession();

/* LOGOUT */

document.getElementById("logoutBtn").addEventListener("click", async () => {
await supabaseClient.auth.signOut();
window.location.href = "./login.html";
});

/* BILL CALC */

function calculateFinal() {

const original = Number(document.getElementById("original").value);
const discountValue = Number(document.getElementById("discountValue").value);
const type = document.getElementById("discountType").value;

if (!original || !discountValue) return;

let final;

if (type === "percent") {
final = original - (original * discountValue / 100);
} else {
final = original - discountValue;
}

if (final < 0) final = 0;

document.getElementById("final").value = final.toFixed(2);

}

document.getElementById("original").addEventListener("input", calculateFinal);
document.getElementById("discountValue").addEventListener("input", calculateFinal);
document.getElementById("discountType").addEventListener("change", calculateFinal);

/* SUBMIT */

document.getElementById("submitBtn").addEventListener("click", async () => {

const resultBox = document.getElementById("result");

resultBox.style.display="block";
resultBox.className="result";
resultBox.innerText="Processing...";

const memberNumber = document.getElementById("memberNumber").value;
const original = Number(document.getElementById("original").value);
const finalBill = Number(document.getElementById("final").value);
const discount = original - finalBill;

const { data: member } = await supabaseClient
.from("members")
.select("id")
.eq("member_number", memberNumber)
.single();

if (!member) {
resultBox.className="result error";
resultBox.innerText="Member not found";
return;
}

const { data, error } = await supabaseClient.rpc("create_redemption", {
p_member_id: member.id,
p_merchant_id: MERCHANT_ID,
p_original_bill: original,
p_discount: discount,
p_final_bill: finalBill
});

if (error) {
resultBox.className="result error";
resultBox.innerText=error.message;
return;
}

resultBox.className="result success";
resultBox.innerText =
"Points Added: " + data.points_added +
" | New Balance: " + data.new_balance;

});

</script>

</body>
</html>
